<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰è¯åœ‹å°PTCèª²è¡¨æŸ¥è©¢ç³»çµ±</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --lunch-bg: #f1f5f9;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 20px; }
        header h1 { color: var(--primary); font-size: 1.5rem; margin-bottom: 5px; }

        .search-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        select, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 1rem;
            outline: none;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .timetable-wrapper {
            background: var(--card);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: center; }
        th { background: #f8fafc; color: #64748b; }

        .period-cell { background: #f1f5f9; font-weight: bold; width: 80px; }
        .subject { color: var(--primary); font-weight: bold; display: block; }
        .teacher-label { font-size: 0.75rem; color: #64748b; margin-top: 2px; display: block; }
        .lunch-row { background: var(--lunch-bg); font-weight: bold; color: #94a3b8; letter-spacing: 0.5em; }

        .status-bar {
            text-align: center;
            font-size: 0.85rem;
            margin-bottom: 10px;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(37,99,235,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ« å…‰è¯åœ‹å°PTCæ ¡åœ’èª²è¡¨æŸ¥è©¢ç³»çµ±</h1>
        <div id="statusMsg" class="status-bar">
            <span class="loading-spinner"></span>æ­£åœ¨è¼‰å…¥é›²ç«¯èª²è¡¨è³‡æ–™...
        </div>
    </header>

    <div class="search-controls">
        <select id="searchType" onchange="updateOptions()">
            <option value="class">æŒ‰ç­ç´šæŸ¥è©¢</option>
            <option value="teacher">æŒ‰æ•™å¸«æŸ¥è©¢</option>
        </select>
        <select id="targetSelect">
            <option value="">è«‹ç¨å€™...</option>
        </select>
        <button onclick="renderTimetable()">é–‹å§‹æŸ¥è©¢</button>
    </div>

    <div class="timetable-wrapper">
        <h2 id="tableTitle" style="text-align: center; font-size: 1.2rem; color: #1e293b;"></h2>
        <table id="timetable">
            <thead>
                <tr>
                    <th>ç¯€æ¬¡</th>
                    <th>é€±ä¸€</th>
                    <th>é€±äºŒ</th>
                    <th>é€±ä¸‰</th>
                    <th>é€±å››</th>
                    <th>é€±äº”</th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>
</div>

<script>
    let timetableData = { classes: {}, teachers: {} };
    // è¨­å®šä½ çš„ CSV æª”æ¡ˆåç¨±ï¼Œè«‹ç¢ºä¿è©²æª”æ¡ˆèˆ‡ index.html æ”¾åœ¨ GitHub åŒä¸€å€‹è³‡æ–™å¤¾
    const CSV_FILE_URL = 'data.csv'; 

    // 1. è‡ªå‹•è¼‰å…¥ï¼šç¶²é å•Ÿå‹•å³å¾ GitHub æŠ“å–æª”æ¡ˆ
    window.onload = function() {
        fetch(CSV_FILE_URL)
            .then(response => {
                if (!response.ok) throw new Error('æ‰¾ä¸åˆ°èª²è¡¨æª”æ¡ˆ (data.csv)');
                // å˜—è©¦è®€å–å…§å®¹ï¼Œå…ˆæŠ“ ArrayBuffer ä»¥ä¾¿è™•ç†ç·¨ç¢¼
                return response.arrayBuffer();
            })
            .then(buffer => {
                // è™•ç†ç·¨ç¢¼ï¼šå…ˆå˜—è©¦ UTF-8ï¼Œå¦‚æœä¸æˆå†å˜—è©¦ Big5
                const decoderUTF8 = new TextDecoder('utf-8');
                let content = decoderUTF8.decode(buffer);
                
                if (!content.includes('é€±æ¬¡')) {
                    const decoderBig5 = new TextDecoder('big5');
                    content = decoderBig5.decode(buffer);
                }
                
                parseCSV(content);
            })
            .catch(err => {
                document.getElementById('statusMsg').innerHTML = `<span style="color:red">âŒ è¼‰å…¥å¤±æ•—ï¼š${err.message}</span><br><small>è«‹ç¢ºèª GitHub å„²å­˜åº«ä¸­å­˜æœ‰ data.csv</small>`;
            });
    };

    function parseCSV(csvText) {
        const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
        const newData = { classes: {}, teachers: {} };
        
        // å–å¾—æ¨™é¡Œä¸¦æ¸…ç† BOM å­—å…ƒ
        const header = lines[0].split(',').map(h => h.trim().replace(/["'\uFEFF]/g, ''));
        
        const findIdx = (ks) => header.findIndex(h => ks.some(k => h.includes(k)));
        const idx = { 
            day: findIdx(["é€±æ¬¡"]), 
            period: findIdx(["ç¯€æ¬¡"]), 
            grade: findIdx(["å¹´ç´š"]), 
            class: findIdx(["ç­ç´š"]), 
            teacher: findIdx(["æ•™å¸«"]), 
            subject: findIdx(["èª²ç¨‹"]) 
        };

        if (idx.day === -1) {
            document.getElementById('statusMsg').innerHTML = "âŒ CSV æ ¼å¼ä¸ç¬¦ (æ‰¾ä¸åˆ°é—œéµæ¬„ä½)";
            return;
        }

        const dayMap = { "é€±ä¸€": 0, "é€±äºŒ": 1, "é€±ä¸‰": 2, "é€±å››": 3, "é€±äº”": 4 };
        const periodMap = { "ç¬¬ä¸€ç¯€": 0, "ç¬¬äºŒç¯€": 1, "ç¬¬ä¸‰ç¯€": 2, "ç¬¬å››ç¯€": 3, "ç¬¬äº”ç¯€": 4, "ç¬¬å…­ç¯€": 5, "ç¬¬ä¸ƒç¯€": 6, "ç¬¬å…«ç¯€": 7 };

        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
            const dIdx = dayMap[cols[idx.day]], pIdx = periodMap[cols[idx.period]];
            if (dIdx === undefined || pIdx === undefined) continue;

            // ç­ç´šè­˜åˆ¥è™•ç† (ä¾‹å¦‚: ä¸€å¹´ç´š 01ç­ -> 101)
            const gradeNum = (str) => {
                const m = {"ä¸€":"1","äºŒ":"2","ä¸‰":"3","å››":"4","äº”":"5","å…­":"6"};
                return m[str.charAt(0)] || str.charAt(0);
            };
            const cKey = `${gradeNum(cols[idx.grade])}${cols[idx.class].replace(/[^0-9]/g, '').padStart(2, '0')}`;
            const tea = cols[idx.teacher], sub = cols[idx.subject];

            // å¡«å…¥ç­ç´šæ•¸æ“š
            if (!newData.classes[cKey]) newData.classes[cKey] = Array.from({length:8}, ()=>Array(5).fill(null));
            newData.classes[cKey][pIdx][dIdx] = { sub, tea };

            // å¡«å…¥æ•™å¸«æ•¸æ“š
            if (tea && tea !== "ç„¡") {
                if (!newData.teachers[tea]) newData.teachers[tea] = Array.from({length:8}, ()=>Array(5).fill(null));
                newData.teachers[tea][pIdx][dIdx] = { sub, cKey };
            }
        }

        timetableData = newData;
        document.getElementById('statusMsg').innerHTML = "âœ… åƒ…ä¾›æŸ¥è©¢èª²è¡¨ä½¿ç”¨";
        updateOptions();
    }

    function updateOptions() {
        const type = document.getElementById('searchType').value;
        const select = document.getElementById('targetSelect');
        const keys = type === 'class' ? Object.keys(timetableData.classes) : Object.keys(timetableData.teachers);
        
        select.innerHTML = '';
        keys.sort().forEach(k => {
            const opt = document.createElement('option');
            opt.value = k;
            opt.textContent = type === 'class' ? `${k} ç­` : `${k} è€å¸«`;
            select.appendChild(opt);
        });
    }

    function renderTimetable() {
        const type = document.getElementById('searchType').value, target = document.getElementById('targetSelect').value;
        const body = document.getElementById('timetableBody');
        if (!target) return;

        document.getElementById('tableTitle').innerHTML = `ğŸ“… ${target}${type==='class'?'ç­':'è€å¸«'} èª²è¡¨`;
        body.innerHTML = '';
        const schedule = type === 'class' ? timetableData.classes[target] : timetableData.teachers[target];
        
        for (let pIdx = 0; pIdx < 8; pIdx++) {
            if (pIdx === 4) body.innerHTML += `<tr class="lunch-row"><td class="period-cell">12:00</td><td colspan="5">åˆ ä¼‘ æ™‚ é–“</td></tr>`;
            let row = `<tr><td class="period-cell">ç¬¬ ${pIdx+1} ç¯€</td>`;
            for (let dIdx = 0; dIdx < 5; dIdx++) {
                const info = schedule[pIdx][dIdx];
                row += `<td>${info ? `<span class="subject">${info.sub}</span><span class="teacher-label">${type==='class'?info.tea:info.cKey+'ç­'}</span>` : '<span style="color:#cbd5e1">-</span>'}</td>`;
            }
            body.innerHTML += row + `</tr>`;
        }
    }
</script>
</body>

</html>

